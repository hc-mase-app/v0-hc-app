<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leadership Activity Form</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #0a0a0a;
      color: #e2e8f0;
      padding: 20px;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: #1a1a1a;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      padding: 30px;
      border: 1px solid #2a2a2a;
    }
    
    .header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 3px solid #D4AF37;
    }
    
    .logo {
      width: 80px;
      height: 80px;
      object-fit: contain;
    }
    
    .title {
      flex: 1;
      text-align: center;
    }
    
    .title h1 {
      color: #D4AF37;
      font-size: 28px;
      font-weight: bold;
    }
    
    .company-select {
      padding: 10px 15px;
      border: 2px solid #D4AF37;
      border-radius: 8px;
      background: #2a2a2a;
      color: #D4AF37;
      font-size: 14px;
      cursor: pointer;
    }
    
    .section {
      margin-bottom: 25px;
    }
    
    .section-header {
      background: #D4AF37;
      color: #000;
      padding: 12px 16px;
      font-weight: bold;
      font-size: 14px;
      border-radius: 4px 4px 0 0;
    }
    
    .section-content {
      border: 2px solid #D4AF37;
      border-top: none;
      padding: 20px;
      background: #1a1a1a;
      border-radius: 0 0 4px 4px;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
    }
    
    .form-group label {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 6px;
      color: #cbd5e0;
    }
    
    .form-group input,
    .form-group textarea {
      padding: 10px;
      border: 1px solid #3a3a3a;
      border-radius: 6px;
      background: #2a2a2a;
      color: #e2e8f0;
      font-size: 14px;
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }
    
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #2a2a2a;
      padding: 10px 15px;
      border-radius: 6px;
      border: 1px solid #3a3a3a;
      cursor: pointer;
    }
    
    .checkbox-label input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #D4AF37;
      cursor: pointer;
    }
    
    .draft-section {
      background: linear-gradient(to right, #2a2a2a, #1a1a1a);
      padding: 20px;
      border-radius: 8px;
      border: 2px solid #D4AF37;
      margin-bottom: 25px;
    }
    
    .draft-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .draft-info {
      color: #cbd5e0;
      font-size: 14px;
    }
    
    .draft-info strong {
      color: #D4AF37;
    }
    
    .draft-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: #D4AF37;
      color: #000;
    }
    
    .btn-primary:hover {
      background: #c49d2f;
    }
    
    .btn-secondary {
      background: transparent;
      color: #D4AF37;
      border: 2px solid #D4AF37;
    }
    
    .btn-secondary:hover {
      background: #D4AF37;
      color: #000;
    }
    
    .btn-danger {
      background: #dc2626;
      color: #fff;
    }
    
    .btn-danger:hover {
      background: #b91c1c;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .draft-list {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #3a3a3a;
    }
    
    .draft-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #1a1a1a;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #3a3a3a;
      margin-bottom: 10px;
    }
    
    .draft-item:hover {
      border-color: #D4AF37;
    }
    
    .draft-item-info h4 {
      color: #e2e8f0;
      font-size: 14px;
      margin-bottom: 5px;
    }
    
    .draft-item-info p {
      color: #94a3b8;
      font-size: 12px;
    }
    
    .draft-item-actions {
      display: flex;
      gap: 8px;
    }
    
    .signatures-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
    }
    
    .signature-box {
      background: #2a2a2a;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #3a3a3a;
    }
    
    .signature-box h4 {
      color: #D4AF37;
      font-size: 14px;
      margin-bottom: 5px;
    }
    
    .signature-box p {
      color: #94a3b8;
      font-size: 12px;
      margin-bottom: 15px;
    }
    
    .signature-canvas-wrapper {
      border: 2px solid #D4AF37;
      border-radius: 6px;
      background: #fff;
      padding: 8px;
      margin-bottom: 10px;
    }
    
    .signature-canvas-wrapper img {
      width: 100%;
      height: 100px;
      object-fit: contain;
    }
    
    .signature-actions {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }
    
    .signature-inputs input {
      width: 100%;
      padding: 8px;
      border: 1px solid #3a3a3a;
      border-radius: 4px;
      background: #1a1a1a;
      color: #e2e8f0;
      font-size: 13px;
      margin-bottom: 8px;
    }
    
    .photo-upload {
      background: #2a2a2a;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #3a3a3a;
    }
    
    .photo-upload h3 {
      color: #D4AF37;
      font-size: 16px;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #D4AF37;
    }
    
    .photo-upload input[type="file"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #3a3a3a;
      border-radius: 6px;
      background: #1a1a1a;
      color: #cbd5e0;
      cursor: pointer;
    }
    
    .photo-preview {
      margin-top: 15px;
      text-align: center;
    }
    
    .photo-preview img {
      max-width: 100%;
      max-height: 400px;
      border: 1px solid #3a3a3a;
      border-radius: 6px;
      margin-bottom: 10px;
    }
    
    .error-text {
      color: #ef4444;
      font-size: 13px;
      margin-top: 5px;
    }
    
    .export-section {
      text-align: center;
      margin-top: 30px;
      padding-top: 30px;
      border-top: 2px solid #2a2a2a;
    }
    
    .export-section .btn {
      padding: 15px 40px;
      font-size: 16px;
    }
    
    .footer {
      text-align: center;
      margin-top: 30px;
      color: #64748b;
      font-size: 13px;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: #1a1a1a;
      border: 2px solid #D4AF37;
      border-radius: 12px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-header h2 {
      color: #D4AF37;
      font-size: 20px;
    }
    
    .modal-close {
      background: transparent;
      border: none;
      color: #D4AF37;
      font-size: 24px;
      cursor: pointer;
      padding: 5px;
      line-height: 1;
    }
    
    .modal-body {
      margin-bottom: 20px;
    }
    
    .modal-body p {
      color: #cbd5e0;
      margin-bottom: 15px;
    }
    
    .modal-body canvas {
      width: 100%;
      height: 250px;
      border: 2px solid #D4AF37;
      border-radius: 6px;
      background: #fff;
      cursor: crosshair;
      touch-action: none;
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #000;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        text-align: center;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .signatures-grid {
        grid-template-columns: 1fr;
      }
      
      .draft-header {
        flex-direction: column;
      }
      
      .draft-buttons {
        width: 100%;
      }
      
      .draft-buttons .btn {
        flex: 1;
      }
    }
  </style>
</head>
<body>

<div class="container">
  <!-- Header -->
  <div class="header">
    <img id="companyLogo" class="logo" src="/placeholder.svg" alt="Logo" style="display:none;">
    <div class="title">
      <h1>LEADERSHIP ACTIVITY</h1>
    </div>
    <select id="companySelect" class="company-select">
      <option value="">-- Pilih Perusahaan --</option>
      <option value="pt_sss">PT SSS</option>
      <option value="pt_gsm">PT GSM</option>
    </select>
  </div>

  <!-- Draft Management -->
  <div class="draft-section">
    <div class="draft-header">
      <div class="draft-info">
        <strong>Draft Tersimpan:</strong> <span id="draftCount">0</span> draft
      </div>
      <div class="draft-buttons">
        <button class="btn btn-primary" onclick="saveDraft()">
          üíæ Simpan Draft Baru
        </button>
        <button class="btn btn-secondary" onclick="toggleDraftsList()">
          üìÅ <span id="draftListToggleText">Lihat</span> Daftar Draft (<span id="draftCountBtn">0</span>)
        </button>
      </div>
    </div>
    <div id="draftsList" class="draft-list" style="display:none;">
      <h3 style="color:#D4AF37;margin-bottom:15px;">Daftar Draft Tersimpan:</h3>
      <div id="draftsContainer"></div>
    </div>
  </div>

  <!-- Activity Section -->
  <div class="section">
    <div class="section-header">ACTIVITY</div>
    <div class="section-content">
      <div class="checkbox-group">
        <label class="checkbox-label">
          <input type="checkbox" name="activity" value="Coaching">
          <span>Coaching</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" name="activity" value="Directing">
          <span>Directing</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" name="activity" value="Mentoring">
          <span>Mentoring</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" name="activity" value="Motivating / Counseling">
          <span>Motivating / Counseling</span>
        </label>
      </div>
    </div>
  </div>

  <!-- Employee Data Section -->
  <div class="section">
    <div class="section-header">DATA KARYAWAN</div>
    <div class="section-content">
      <div class="form-grid">
        <div class="form-group">
          <label>NIK:</label>
          <input type="text" id="nik" placeholder="Masukkan NIK">
        </div>
        <div class="form-group">
          <label>Departemen:</label>
          <input type="text" id="departemen" placeholder="Masukkan Departemen">
        </div>
        <div class="form-group">
          <label>Nama:</label>
          <input type="text" id="nama" placeholder="Masukkan Nama">
        </div>
        <div class="form-group">
          <label>Lokasi Kerja:</label>
          <input type="text" id="lokasi" placeholder="Masukkan Lokasi">
        </div>
        <div class="form-group">
          <label>Jabatan:</label>
          <input type="text" id="jabatan" placeholder="Masukkan Jabatan">
        </div>
        <div class="form-group">
          <label>Tanggal Masuk:</label>
          <input type="text" id="tanggal_masuk" placeholder="DD/MM/YYYY">
        </div>
      </div>
    </div>
  </div>

  <!-- Problem Section -->
  <div class="section">
    <div class="section-header">MASALAH</div>
    <div class="section-content">
      <textarea id="masalah" placeholder="Jelaskan masalah yang dihadapi..."></textarea>
    </div>
  </div>

  <!-- Follow-up Section -->
  <div class="section">
    <div class="section-header">TINDAK LANJUT / SOLUSI</div>
    <div class="section-content">
      <textarea id="tindak_lanjut" placeholder="Jelaskan tindak lanjut atau solusi..."></textarea>
    </div>
  </div>

  <!-- Commitment Section -->
  <div class="section">
    <div class="section-header">KOMITMEN</div>
    <div class="section-content">
      <textarea id="komitmen" placeholder="Jelaskan komitmen yang disepakati..."></textarea>
    </div>
  </div>

  <!-- Notes -->
  <div class="section">
    <div class="section-content">
      <div class="form-group">
        <label>Catatan:</label>
        <input type="text" id="catatan" placeholder="Tambahkan catatan jika diperlukan">
      </div>
    </div>
  </div>

  <!-- Signatures Section -->
  <div class="section">
    <div class="section-header">TANDA TANGAN</div>
    <div class="section-content">
      <div class="signatures-grid">
        <!-- Atasan -->
        <div class="signature-box">
          <h4>Dibuat oleh,</h4>
          <p>Atasan Langsung</p>
          <div id="signaturePreview_atasan" style="display:none;">
            <div class="signature-canvas-wrapper">
              <img id="signatureImg_atasan" src="/placeholder.svg" alt="Signature">
            </div>
            <div class="signature-actions">
              <button class="btn btn-secondary" style="flex:1;" onclick="editSignature('atasan')">
                ‚úèÔ∏è Edit
              </button>
              <button class="btn btn-danger" style="flex:1;" onclick="clearSignature('atasan')">
                ‚úñ Hapus
              </button>
            </div>
          </div>
          <button id="signatureBtn_atasan" class="btn btn-primary" style="width:100%;margin-bottom:10px;" onclick="openSignatureModal('atasan')">
            ‚úçÔ∏è Tanda Tangan
          </button>
          <div class="signature-inputs">
            <input type="text" id="signatureName_atasan" placeholder="Nama">
            <input type="text" id="signatureDate_atasan" placeholder="Tanggal">
          </div>
        </div>

        <!-- Karyawan -->
        <div class="signature-box">
          <h4>Diterima oleh,</h4>
          <p>Karyawan</p>
          <div id="signaturePreview_karyawan" style="display:none;">
            <div class="signature-canvas-wrapper">
              <img id="signatureImg_karyawan" src="/placeholder.svg" alt="Signature">
            </div>
            <div class="signature-actions">
              <button class="btn btn-secondary" style="flex:1;" onclick="editSignature('karyawan')">
                ‚úèÔ∏è Edit
              </button>
              <button class="btn btn-danger" style="flex:1;" onclick="clearSignature('karyawan')">
                ‚úñ Hapus
              </button>
            </div>
          </div>
          <button id="signatureBtn_karyawan" class="btn btn-primary" style="width:100%;margin-bottom:10px;" onclick="openSignatureModal('karyawan')">
            ‚úçÔ∏è Tanda Tangan
          </button>
          <div class="signature-inputs">
            <input type="text" id="signatureName_karyawan" placeholder="Nama">
            <input type="text" id="signatureDate_karyawan" placeholder="Tanggal">
          </div>
        </div>

        <!-- PJO -->
        <div class="signature-box">
          <h4>Diketahui oleh,</h4>
          <p>PJO / Mgr. / GM / Dir.</p>
          <div id="signaturePreview_pjo" style="display:none;">
            <div class="signature-canvas-wrapper">
              <img id="signatureImg_pjo" src="/placeholder.svg" alt="Signature">
            </div>
            <div class="signature-actions">
              <button class="btn btn-secondary" style="flex:1;" onclick="editSignature('pjo')">
                ‚úèÔ∏è Edit
              </button>
              <button class="btn btn-danger" style="flex:1;" onclick="clearSignature('pjo')">
                ‚úñ Hapus
              </button>
            </div>
          </div>
          <button id="signatureBtn_pjo" class="btn btn-primary" style="width:100%;margin-bottom:10px;" onclick="openSignatureModal('pjo')">
            ‚úçÔ∏è Tanda Tangan
          </button>
          <div class="signature-inputs">
            <input type="text" id="signatureName_pjo" placeholder="Nama">
            <input type="text" id="signatureDate_pjo" placeholder="Tanggal">
          </div>
        </div>

        <!-- HCGA -->
        <div class="signature-box">
          <h4>HCGA</h4>
          <p>Dic / Pic</p>
          <div id="signaturePreview_hcga" style="display:none;">
            <div class="signature-canvas-wrapper">
              <img id="signatureImg_hcga" src="/placeholder.svg" alt="Signature">
            </div>
            <div class="signature-actions">
              <button class="btn btn-secondary" style="flex:1;" onclick="editSignature('hcga')">
                ‚úèÔ∏è Edit
              </button>
              <button class="btn btn-danger" style="flex:1;" onclick="clearSignature('hcga')">
                ‚úñ Hapus
              </button>
            </div>
          </div>
          <button id="signatureBtn_hcga" class="btn btn-primary" style="width:100%;margin-bottom:10px;" onclick="openSignatureModal('hcga')">
            ‚úçÔ∏è Tanda Tangan
          </button>
          <div class="signature-inputs">
            <input type="text" id="signatureName_hcga" placeholder="Nama">
            <input type="text" id="signatureDate_hcga" placeholder="Tanggal">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Photo Upload Section -->
  <div class="section">
    <div class="section-content">
      <div class="photo-upload">
        <h3>BUKTI PERTEMUAN (FOTO)</h3>
        <input type="file" id="photoUpload" accept="image/*" onchange="handlePhotoUpload(event)">
        <p id="photoError" class="error-text" style="display:none;"></p>
        <div id="photoPreview" class="photo-preview" style="display:none;">
          <img id="photoImg" src="/placeholder.svg" alt="Photo Preview">
          <button class="btn btn-danger" onclick="clearPhoto()">
            ‚úñ Hapus Foto
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Export Section -->
  <div class="export-section">
    <button id="exportBtn" class="btn btn-primary" onclick="exportToPDF()">
      üìÑ Simpan sebagai PDF
    </button>
  </div>

  <!-- Footer -->
  <div class="footer">
    <p>Form Leadership Activity</p>
    <p>- Yan -</p>
  </div>
</div>

<!-- Signature Modal -->
<div id="signatureModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modalTitle">Tanda Tangan</h2>
      <button class="modal-close" onclick="closeSignatureModal()">√ó</button>
    </div>
    <div class="modal-body">
      <p>Tanda tangani di area putih di bawah ini:</p>
      <canvas id="signatureCanvas"></canvas>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="clearCanvas()">
        ‚úñ Hapus
      </button>
      <button class="btn btn-primary" onclick="saveSignature()">
        Simpan Tanda Tangan
      </button>
    </div>
  </div>
</div>

<script>
  // Global State
  let currentSignatureKey = '';
  let isDrawing = false;
  let signatures = {
    atasan: null,
    karyawan: null,
    pjo: null,
    hcga: null
  };
  let photoData = null;

  // Initialize
  window.onload = function() {
    // Set today's date for all signatures
    const today = new Date().toLocaleDateString('id-ID');
    ['atasan', 'karyawan', 'pjo', 'hcga'].forEach(key => {
      document.getElementById(`signatureDate_${key}`).value = today;
    });
    
    loadDrafts();
    
    // Company select change
    document.getElementById('companySelect').addEventListener('change', function() {
      const value = this.value;
      const logo = document.getElementById('companyLogo');
      if (value === 'pt_sss') {
        logo.src = '/sss-logo.png';
        logo.style.display = 'block';
      } else if (value === 'pt_gsm') {
        logo.src = '/gsm-logo.png';
        logo.style.display = 'block';
      } else {
        logo.style.display = 'none';
      }
    });
  };

  // Signature Modal Functions
  function openSignatureModal(key) {
    currentSignatureKey = key;
    const titles = {
      atasan: 'Tanda Tangan - Atasan Langsung',
      karyawan: 'Tanda Tangan - Karyawan',
      pjo: 'Tanda Tangan - PJO / Mgr. / GM / Dir.',
      hcga: 'Tanda Tangan - HCGA'
    };
    document.getElementById('modalTitle').textContent = titles[key];
    document.getElementById('signatureModal').classList.add('active');
    
    setTimeout(() => {
      const canvas = document.getElementById('signatureCanvas');
      canvas.width = canvas.offsetWidth;
      canvas.height = 250;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = 'white';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.strokeStyle = '#000';
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
    }, 100);
  }

  function closeSignatureModal() {
    document.getElementById('signatureModal').classList.remove('active');
  }

  function clearCanvas() {
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  }

  function saveSignature() {
    const canvas = document.getElementById('signatureCanvas');
    const signatureDataUrl = canvas.toDataURL('image/png');
    signatures[currentSignatureKey] = signatureDataUrl;
    
    // Update UI
    document.getElementById(`signatureImg_${currentSignatureKey}`).src = signatureDataUrl;
    document.getElementById(`signaturePreview_${currentSignatureKey}`).style.display = 'block';
    document.getElementById(`signatureBtn_${currentSignatureKey}`).style.display = 'none';
    
    closeSignatureModal();
  }

  function editSignature(key) {
    openSignatureModal(key);
  }

  function clearSignature(key) {
    if (confirm('Hapus tanda tangan ini?')) {
      signatures[key] = null;
      document.getElementById(`signaturePreview_${key}`).style.display = 'none';
      document.getElementById(`signatureBtn_${key}`).style.display = 'block';
    }
  }

  // Canvas Drawing
  const canvas = document.getElementById('signatureCanvas');
  
  canvas.addEventListener('mousedown', startDrawing);
  canvas.addEventListener('mousemove', draw);
  canvas.addEventListener('mouseup', stopDrawing);
  canvas.addEventListener('mouseout', stopDrawing);
  
  canvas.addEventListener('touchstart', startDrawing);
  canvas.addEventListener('touchmove', draw);
  canvas.addEventListener('touchend', stopDrawing);

  function startDrawing(e) {
    e.preventDefault();
    isDrawing = true;
    const ctx = canvas.getContext('2d');
    const coords = getCoordinates(e);
    ctx.beginPath();
    ctx.moveTo(coords.x, coords.y);
  }

  function draw(e) {
    e.preventDefault();
    if (!isDrawing) return;
    const ctx = canvas.getContext('2d');
    const coords = getCoordinates(e);
    ctx.lineTo(coords.x, coords.y);
    ctx.stroke();
  }

  function stopDrawing() {
    isDrawing = false;
  }

  function getCoordinates(e) {
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    
    const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
    const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
    
    return {
      x: (clientX - rect.left) * scaleX,
      y: (clientY - rect.top) * scaleY
    };
  }

  // Photo Upload
  function handlePhotoUpload(event) {
    const file = event.target.files[0];
    const errorEl = document.getElementById('photoError');
    
    if (!file) {
      errorEl.textContent = 'Tidak ada file yang dipilih';
      errorEl.style.display = 'block';
      photoData = null;
      return;
    }
    
    if (!file.type.startsWith('image/')) {
      errorEl.textContent = 'File yang dipilih bukan gambar';
      errorEl.style.display = 'block';
      photoData = null;
      return;
    }
    
    if (file.size > 5 * 1024 * 1024) {
      errorEl.textContent = 'Ukuran file terlalu besar (maksimal 5MB)';
      errorEl.style.display = 'block';
      photoData = null;
      return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
      const img = new Image();
      img.onload = function() {
        const canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        
        photoData = canvas.toDataURL('image/jpeg', 1.0);
        document.getElementById('photoImg').src = photoData;
        document.getElementById('photoPreview').style.display = 'block';
        errorEl.style.display = 'none';
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }

  function clearPhoto() {
    if (confirm('Hapus foto ini?')) {
      photoData = null;
      document.getElementById('photoPreview').style.display = 'none';
      document.getElementById('photoUpload').value = '';
    }
  }

  // Draft Management
  function saveDraft() {
    const name = prompt('Nama draft (contoh: NIK - Nama Karyawan):', 
      document.getElementById('nik').value && document.getElementById('nama').value 
        ? `${document.getElementById('nik').value} - ${document.getElementById('nama').value}` 
        : '');
    
    if (!name || !name.trim()) {
      alert('Nama draft tidak boleh kosong');
      return;
    }
    
    const draft = {
      id: Date.now().toString(),
      name: name.trim(),
      selectedCompany: document.getElementById('companySelect').value,
      activities: getSelectedActivities(),
      formData: getFormData(),
      signatures: getSignaturesData(),
      photoData: photoData,
      savedAt: new Date().toISOString()
    };
    
    const drafts = JSON.parse(localStorage.getItem('leadershipActivityDrafts') || '[]');
    drafts.push(draft);
    localStorage.setItem('leadershipActivityDrafts', JSON.stringify(drafts));
    
    loadDrafts();
    alert(`Draft "${name}" berhasil disimpan!`);
  }

  function loadDrafts() {
    const drafts = JSON.parse(localStorage.getItem('leadershipActivityDrafts') || '[]');
    document.getElementById('draftCount').textContent = drafts.length;
    document.getElementById('draftCountBtn').textContent = drafts.length;
    
    const container = document.getElementById('draftsContainer');
    if (drafts.length === 0) {
      container.innerHTML = '<p style="text-align:center;color:#94a3b8;padding:20px;">Belum ada draft tersimpan</p>';
    } else {
      container.innerHTML = drafts.map(draft => `
        <div class="draft-item">
          <div class="draft-item-info">
            <h4>${draft.name}</h4>
            <p>Disimpan: ${new Date(draft.savedAt).toLocaleString('id-ID')}</p>
            <p>${draft.selectedCompany === 'pt_sss' ? 'PT SSS' : draft.selectedCompany === 'pt_gsm' ? 'PT GSM' : 'Belum pilih perusahaan'}</p>
          </div>
          <div class="draft-item-actions">
            <button class="btn btn-primary" onclick="loadDraft('${draft.id}')">
              üìÅ Muat
            </button>
            <button class="btn btn-danger" onclick="deleteDraft('${draft.id}', '${draft.name}')">
              üóëÔ∏è
            </button>
          </div>
        </div>
      `).join('');
    }
  }

  function toggleDraftsList() {
    const list = document.getElementById('draftsList');
    const toggleText = document.getElementById('draftListToggleText');
    if (list.style.display === 'none') {
      list.style.display = 'block';
      toggleText.textContent = 'Tutup';
    } else {
      list.style.display = 'none';
      toggleText.textContent = 'Lihat';
    }
  }

  function loadDraft(id) {
    if (!confirm('Memuat draft akan mengganti data yang sedang diisi. Lanjutkan?')) return;
    
    const drafts = JSON.parse(localStorage.getItem('leadershipActivityDrafts') || '[]');
    const draft = drafts.find(d => d.id === id);
    if (!draft) return;
    
    // Load company
    document.getElementById('companySelect').value = draft.selectedCompany || '';
    document.getElementById('companySelect').dispatchEvent(new Event('change'));
    
    // Load activities
    document.querySelectorAll('input[name="activity"]').forEach(cb => {
      cb.checked = draft.activities.includes(cb.value);
    });
    
    // Load form data
    Object.keys(draft.formData).forEach(key => {
      const el = document.getElementById(key);
      if (el) el.value = draft.formData[key] || '';
    });
    
    // Load signatures
    Object.keys(draft.signatures).forEach(key => {
      const sig = draft.signatures[key];
      if (sig.data) {
        signatures[key] = sig.data;
        document.getElementById(`signatureImg_${key}`).src = sig.data;
        document.getElementById(`signaturePreview_${key}`).style.display = 'block';
        document.getElementById(`signatureBtn_${key}`).style.display = 'none';
      }
      if (sig.nama) document.getElementById(`signatureName_${key}`).value = sig.nama;
      if (sig.tanggal) document.getElementById(`signatureDate_${key}`).value = sig.tanggal;
    });
    
    // Load photo
    if (draft.photoData) {
      photoData = draft.photoData;
      document.getElementById('photoImg').src = photoData;
      document.getElementById('photoPreview').style.display = 'block';
    }
    
    toggleDraftsList();
    alert(`Draft "${draft.name}" berhasil dimuat!`);
  }

  function deleteDraft(id, name) {
    if (!confirm(`Hapus draft "${name}"? Tindakan ini tidak dapat dibatalkan.`)) return;
    
    const drafts = JSON.parse(localStorage.getItem('leadershipActivityDrafts') || '[]');
    const filtered = drafts.filter(d => d.id !== id);
    localStorage.setItem('leadershipActivityDrafts', JSON.stringify(filtered));
    
    loadDrafts();
    alert(`Draft "${name}" berhasil dihapus`);
  }

  function getSelectedActivities() {
    const activities = [];
    document.querySelectorAll('input[name="activity"]:checked').forEach(cb => {
      activities.push(cb.value);
    });
    return activities;
  }

  function getFormData() {
    return {
      nik: document.getElementById('nik').value,
      departemen: document.getElementById('departemen').value,
      nama: document.getElementById('nama').value,
      lokasi: document.getElementById('lokasi').value,
      jabatan: document.getElementById('jabatan').value,
      tanggal_masuk: document.getElementById('tanggal_masuk').value,
      masalah: document.getElementById('masalah').value,
      tindak_lanjut: document.getElementById('tindak_lanjut').value,
      komitmen: document.getElementById('komitmen').value,
      catatan: document.getElementById('catatan').value
    };
  }

  function getSignaturesData() {
    return {
      atasan: {
        data: signatures.atasan,
        nama: document.getElementById('signatureName_atasan').value,
        tanggal: document.getElementById('signatureDate_atasan').value
      },
      karyawan: {
        data: signatures.karyawan,
        nama: document.getElementById('signatureName_karyawan').value,
        tanggal: document.getElementById('signatureDate_karyawan').value
      },
      pjo: {
        data: signatures.pjo,
        nama: document.getElementById('signatureName_pjo').value,
        tanggal: document.getElementById('signatureDate_pjo').value
      },
      hcga: {
        data: signatures.hcga,
        nama: document.getElementById('signatureName_hcga').value,
        tanggal: document.getElementById('signatureDate_hcga').value
      }
    };
  }

  // PDF Export
  function exportToPDF() {
    const company = document.getElementById('companySelect').value;
    const formData = getFormData();
    const activities = getSelectedActivities();
    const signaturesData = getSignaturesData();
    
    // Validation
    if (!company) {
      alert('Silakan pilih perusahaan terlebih dahulu');
      return;
    }
    if (!formData.nama.trim()) {
      alert('Nama harus diisi');
      return;
    }
    if (!formData.nik.trim()) {
      alert('NIK harus diisi');
      return;
    }
    if (activities.length === 0) {
      alert('Silakan pilih minimal 1 activity');
      return;
    }
    if (!formData.masalah.trim()) {
      alert('Masalah harus diisi');
      return;
    }
    if (!formData.tindak_lanjut.trim()) {
      alert('Tindak lanjut/solusi harus diisi');
      return;
    }
    if (!formData.komitmen.trim()) {
      alert('Komitmen harus diisi');
      return;
    }
    
    const hasSignature = Object.values(signatures).some(sig => sig !== null);
    if (!hasSignature) {
      alert('Minimal harus ada 1 tanda tangan');
      return;
    }
    
    // Disable button
    const btn = document.getElementById('exportBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="loading-spinner"></span> Membuat PDF...';
    
    try {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const margin = 15;
      const contentWidth = pageWidth - margin * 2;
      let yPos = margin;
      
      // Header
      doc.setFontSize(16);
      doc.setFont('helvetica', 'bold');
      doc.text('FORMULIR LEADERSHIP ACTIVITY', pageWidth / 2, yPos + 12, { align: 'center' });
      yPos += 30;
      
      // Activity
      doc.setFontSize(10);
      doc.setFont('helvetica', 'bold');
      doc.setFillColor(220, 220, 220);
      doc.rect(margin, yPos, contentWidth, 7, 'F');
      doc.text('ACTIVITY', margin + 2, yPos + 5);
      yPos += 7;
      
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(9);
      doc.rect(margin, yPos, contentWidth, 10);
      doc.text(activities.join(', ') || '-', margin + 2, yPos + 6);
      yPos += 12;
      
      // Employee Data
      doc.setFontSize(10);
      doc.setFont('helvetica', 'bold');
      doc.setFillColor(220, 220, 220);
      doc.rect(margin, yPos, contentWidth, 7, 'F');
      doc.text('Data Karyawan', margin + 2, yPos + 5);
      yPos += 7;
      
      const colWidth = contentWidth / 2;
      const rowHeight = 8;
      const employeeData = [
        ['NIK', formData.nik || '-', 'Departemen', formData.departemen || '-'],
        ['Nama', formData.nama || '-', 'Lokasi Kerja', formData.lokasi || '-'],
        ['Jabatan', formData.jabatan || '-', 'Tanggal Masuk', formData.tanggal_masuk || '-']
      ];
      
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(9);
      
      employeeData.forEach(row => {
        doc.rect(margin, yPos, colWidth, rowHeight);
        doc.setFont('helvetica', 'bold');
        doc.text(row[0], margin + 2, yPos + 5);
        doc.setFont('helvetica', 'normal');
        doc.text(row[1], margin + 30, yPos + 5);
        
        doc.rect(margin + colWidth, yPos, colWidth, rowHeight);
        doc.setFont('helvetica', 'bold');
        doc.text(row[2], margin + colWidth + 2, yPos + 5);
        doc.setFont('helvetica', 'normal');
        doc.text(row[3], margin + colWidth + 30, yPos + 5);
        
        yPos += rowHeight;
      });
      yPos += 3;
      
      // Problem
      doc.setFontSize(10);
      doc.setFont('helvetica', 'bold');
      doc.setFillColor(220, 220, 220);
      doc.rect(margin, yPos, contentWidth, 7, 'F');
      doc.text('MASALAH', margin + 2, yPos + 5);
      yPos += 7;
      
      doc.setFont('helvetica', 'normal');
      const masalahLines = doc.splitTextToSize(formData.masalah || '-', contentWidth - 4);
      const masalahHeight = Math.max(15, masalahLines.length * 5 + 4);
      doc.rect(margin, yPos, contentWidth, masalahHeight);
      doc.text(masalahLines, margin + 2, yPos + 5);
      yPos += masalahHeight + 3;
      
      // Follow-up
      doc.setFont('helvetica', 'bold');
      doc.setFillColor(220, 220, 220);
      doc.rect(margin, yPos, contentWidth, 7, 'F');
      doc.text('TINDAK LANJUT / SOLUSI', margin + 2, yPos + 5);
      yPos += 7;
      
      doc.setFont('helvetica', 'normal');
      const tindakLanjutLines = doc.splitTextToSize(formData.tindak_lanjut || '-', contentWidth - 4);
      const tindakLanjutHeight = Math.max(15, tindakLanjutLines.length * 5 + 4);
      doc.rect(margin, yPos, contentWidth, tindakLanjutHeight);
      doc.text(tindakLanjutLines, margin + 2, yPos + 5);
      yPos += tindakLanjutHeight + 3;
      
      // Commitment
      doc.setFont('helvetica', 'bold');
      doc.setFillColor(220, 220, 220);
      doc.rect(margin, yPos, contentWidth, 7, 'F');
      doc.text('KOMITMEN', margin + 2, yPos + 5);
      yPos += 7;
      
      doc.setFont('helvetica', 'normal');
      const komitmenLines = doc.splitTextToSize(formData.komitmen || '-', contentWidth - 4);
      const komitmenHeight = Math.max(15, komitmenLines.length * 5 + 4);
      doc.rect(margin, yPos, contentWidth, komitmenHeight);
      doc.text(komitmenLines, margin + 2, yPos + 5);
      yPos += komitmenHeight + 3;
      
      // Notes
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(9);
      doc.text(`Catatan: ${formData.catatan || '-'}`, margin, yPos);
      yPos += 8;
      
      // Signatures
      const sigWidth = contentWidth / 4;
      const signaturesList = [
        { key: 'atasan', title: 'Dibuat oleh,', subtitle: 'Atasan Langsung' },
        { key: 'karyawan', title: 'Diterima oleh,', subtitle: 'Karyawan' },
        { key: 'pjo', title: 'Diketahui oleh,', subtitle: 'PJO / Mgr. / GM / Dir.' },
        { key: 'hcga', title: 'HCGA', subtitle: 'Dic / Pic' }
      ];
      
      doc.setFontSize(8);
      signaturesList.forEach((sig, idx) => {
        const xPos = margin + idx * sigWidth;
        const sigInfo = signaturesData[sig.key];
        const signatureDataUrl = signatures[sig.key];
        
        doc.setFont('helvetica', 'bold');
        doc.text(sig.title, xPos + sigWidth / 2, yPos, { align: 'center' });
        doc.setFont('helvetica', 'normal');
        doc.text(sig.subtitle, xPos + sigWidth / 2, yPos + 4, { align: 'center' });
        
        if (signatureDataUrl) {
          try {
            doc.addImage(signatureDataUrl, 'PNG', xPos + 5, yPos + 6, sigWidth - 10, 15);
          } catch (e) {
            console.error(`Error adding signature ${sig.key}:`, e);
          }
        }
        
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(7);
        doc.text(sigInfo?.nama || '-', xPos + sigWidth / 2, yPos + 25, { align: 'center' });
        doc.text(sigInfo?.tanggal || '-', xPos + sigWidth / 2, yPos + 29, { align: 'center' });
      });
      
      // Photo (if exists)
      if (photoData) {
        doc.addPage();
        yPos = margin;
        
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text('BUKTI PERTEMUAN (FOTO)', pageWidth / 2, yPos, { align: 'center' });
        yPos += 10;
        
        const img = new Image();
        img.src = photoData;
        
        const imgWidth = img.width;
        const imgHeight = img.height;
        const imgRatio = imgWidth / imgHeight;
        
        const maxWidth = contentWidth;
        const maxHeight = pageHeight - yPos - margin - 10;
        const maxRatio = maxWidth / maxHeight;
        
        let finalWidth, finalHeight;
        if (imgRatio > maxRatio) {
          finalWidth = maxWidth;
          finalHeight = maxWidth / imgRatio;
        } else {
          finalHeight = maxHeight;
          finalWidth = maxHeight * imgRatio;
        }
        
        const xCenter = (pageWidth - finalWidth) / 2;
        
        try {
          doc.addImage(photoData, 'JPEG', xCenter, yPos, finalWidth, finalHeight);
        } catch (e) {
          console.error('Error adding photo:', e);
        }
      }
      
      // Generate filename
      const sanitize = (str) => str.replace(/[^a-zA-Z0-9\s]/g, '_').replace(/\s+/g, '_').substring(0, 50);
      const namaAtasan = sanitize(signaturesData.atasan.nama || 'Atasan');
      const namaBawahan = sanitize(formData.nama || 'Karyawan');
      const jabatan = sanitize(formData.jabatan || 'Jabatan');
      const departemen = sanitize(formData.departemen || 'Departemen');
      const activityFormatted = activities.map(act => {
        const lower = act.toLowerCase();
        if (lower.includes('coaching')) return 'coaching';
        if (lower.includes('directing')) return 'directing';
        if (lower.includes('mentoring')) return 'mentoring';
        if (lower.includes('motivating') || lower.includes('counseling')) return 'counseling';
        return lower;
      }).join('_');
      
      const filename = `${namaAtasan}_${activityFormatted}_${namaBawahan}_${jabatan}_${departemen}.pdf`;
      
      // Save PDF
      doc.save(filename);
      
      alert('PDF berhasil didownload!');
    } catch (error) {
      console.error('Error generating PDF:', error);
      alert('Gagal membuat PDF: ' + error.message);
    } finally {
      btn.disabled = false;
      btn.innerHTML = 'üìÑ Simpan sebagai PDF';
    }
  }
</script>

</body>
</html>
